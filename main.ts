function playSimonSequence () {
    pause(SIMON_START_DELAY)
    for (let index = 0; index <= SIMON_INTERATIONS - 1; index++) {
        playSimon(simonSequence[index])
        pause(SIMON_TEMPO)
    }
    gameboard = sprites.create(SPRITE_ARRAY[4], SpriteKind.Player)
}
function playSimon (key: number) {
    gameboard = sprites.create(SPRITE_ARRAY[key], SpriteKind.Player)
    music.playTone(NOTES[key], music.beat(BeatFraction.Whole))
    music.rest(music.beat(BeatFraction.Quarter))
    gameboard = sprites.create(SPRITE_ARRAY[4], SpriteKind.Player)
}
function challenge1 () {
    music.play(music.melodyPlayable(music.baDing), music.PlaybackMode.UntilDone)
    if (state == "init") {
        setupChallenge1()
        playSimonSequence()
    }
    state = "challenge1"
    state_step = 0
}
controller.down.onEvent(ControllerButtonEvent.Released, function () {
    if (state == "challenge1") {
        playSimon(2)
        checkSimon(2)
    }
})
controller.right.onEvent(ControllerButtonEvent.Released, function () {
    if (state == "challenge1") {
        playSimon(1)
        checkSimon(1)
    }
})
controller.left.onEvent(ControllerButtonEvent.Released, function () {
    if (state == "challenge1") {
        playSimon(3)
        checkSimon(3)
    }
})
controller.onGesture(ControllerGesture.TwoG, function () {
    if (state == "challenge3b") {
        music.play(music.melodyPlayable(music.knock), music.PlaybackMode.UntilDone)
        state_step += 1
    }
})
controller.A.onEvent(ControllerButtonEvent.Released, function () {
    if (state == "challenge1") {
        state = "init"
        challenge1()
    }
})
function challenge3 () {
    music.play(music.createSong(hex`0078000408010100001c00010a006400f4016400000400000000000000000000000000050000041e0000000400012508000c0001200c001000012010001400012218001c000120`), music.PlaybackMode.UntilDone)
    state_step = 0
    state = "challenge3b"
}
controller.up.onEvent(ControllerButtonEvent.Released, function () {
    if (state == "challenge1") {
        playSimon(0)
        checkSimon(0)
    }
})
function setupChallenge1 () {
    gameboard = sprites.create(SPRITE_ARRAY[4], SpriteKind.Player)
    simonSequence = [
    randint(0, 3),
    randint(0, 3),
    randint(0, 3),
    randint(0, 3),
    randint(0, 3),
    randint(0, 3)
    ]
}
function Init () {
    // Houdini's birthday
    PASSWORD = 324
    clue = "\"My birth is the key that sets you free\" -- E.W."
    game.setGameOverMessage(true, "ACCESS GRANTED!")
    // Length of simon says sequence
    SIMON_INTERATIONS = 5
    SIMON_TEMPO = 100
    SIMON_START_DELAY = 2000
    NOTES = [
    220,
    262,
    330,
    392
    ]
    SPRITE_ARRAY = [
    img`
        111111111111111111111111111111111111111111111111
        113333333333333333333333333333333333333333333311
        161333333333333333333333333333333333333333333181
        166133333333333333333333333333333333333333331881
        166613333333333333333333333333333333333333318881
        166661333333333333333333333333333333333333188881
        166666133333333333333333333333333333333331888881
        166666613333333333333333333333333333333318888881
        166666661333333333333333333333333333333188888881
        166666666133333333333333333333333333331888888881
        166666666613333333333333333333333333318888888881
        166666666661333333333333333333333333188888888881
        166666666666133333333333333333333331888888888881
        166666666666613333333333333333333318888888888881
        166666666666661333333333333333333188888888888881
        166666666666666133333333333333331888888888888881
        166666666666666613333333333333318888888888888881
        166666666666666661333333333333188888888888888881
        166666666666666666133333333331888888888888888881
        166666666666666666613333333318888888888888888881
        166666666666666666661333333188888888888888888881
        166666666666666666666133331888888888888888888881
        166666666666666666666613318888888888888888888881
        166666666666666666666661188888888888888888888881
        166666666666666666666661188888888888888888888881
        166666666666666666666614418888888888888888888881
        166666666666666666666144441888888888888888888881
        166666666666666666661444444188888888888888888881
        166666666666666666614444444418888888888888888881
        166666666666666666144444444441888888888888888881
        166666666666666661444444444444188888888888888881
        166666666666666614444444444444418888888888888881
        166666666666666144444444444444441888888888888881
        166666666666661444444444444444444188888888888881
        166666666666614444444444444444444418888888888881
        166666666666144444444444444444444441888888888881
        166666666661444444444444444444444444188888888881
        166666666614444444444444444444444444418888888881
        166666666144444444444444444444444444441888888881
        166666661444444444444444444444444444444188888881
        166666614444444444444444444444444444444418888881
        166666144444444444444444444444444444444441888881
        166661444444444444444444444444444444444444188881
        166614444444444444444444444444444444444444418881
        166144444444444444444444444444444444444444441881
        161444444444444444444444444444444444444444444181
        114444444444444444444444444444444444444444444411
        111111111111111111111111111111111111111111111111
        `,
    img`
        111111111111111111111111111111111111111111111111
        112222222222222222222222222222222222222222222211
        161222222222222222222222222222222222222222222191
        166122222222222222222222222222222222222222221991
        166612222222222222222222222222222222222222219991
        166661222222222222222222222222222222222222199991
        166666122222222222222222222222222222222221999991
        166666612222222222222222222222222222222219999991
        166666661222222222222222222222222222222199999991
        166666666122222222222222222222222222221999999991
        166666666612222222222222222222222222219999999991
        166666666661222222222222222222222222199999999991
        166666666666122222222222222222222221999999999991
        166666666666612222222222222222222219999999999991
        166666666666661222222222222222222199999999999991
        166666666666666122222222222222221999999999999991
        166666666666666612222222222222219999999999999991
        166666666666666661222222222222199999999999999991
        166666666666666666122222222221999999999999999991
        166666666666666666612222222219999999999999999991
        166666666666666666661222222199999999999999999991
        166666666666666666666122221999999999999999999991
        166666666666666666666612219999999999999999999991
        166666666666666666666661199999999999999999999991
        166666666666666666666661199999999999999999999991
        166666666666666666666614419999999999999999999991
        166666666666666666666144441999999999999999999991
        166666666666666666661444444199999999999999999991
        166666666666666666614444444419999999999999999991
        166666666666666666144444444441999999999999999991
        166666666666666661444444444444199999999999999991
        166666666666666614444444444444419999999999999991
        166666666666666144444444444444441999999999999991
        166666666666661444444444444444444199999999999991
        166666666666614444444444444444444419999999999991
        166666666666144444444444444444444441999999999991
        166666666661444444444444444444444444199999999991
        166666666614444444444444444444444444419999999991
        166666666144444444444444444444444444441999999991
        166666661444444444444444444444444444444199999991
        166666614444444444444444444444444444444419999991
        166666144444444444444444444444444444444441999991
        166661444444444444444444444444444444444444199991
        166614444444444444444444444444444444444444419991
        166144444444444444444444444444444444444444441991
        161444444444444444444444444444444444444444444191
        114444444444444444444444444444444444444444444411
        111111111111111111111111111111111111111111111111
        `,
    img`
        111111111111111111111111111111111111111111111111
        112222222222222222222222222222222222222222222211
        161222222222222222222222222222222222222222222181
        166122222222222222222222222222222222222222221881
        166612222222222222222222222222222222222222218881
        166661222222222222222222222222222222222222188881
        166666122222222222222222222222222222222221888881
        166666612222222222222222222222222222222218888881
        166666661222222222222222222222222222222188888881
        166666666122222222222222222222222222221888888881
        166666666612222222222222222222222222218888888881
        166666666661222222222222222222222222188888888881
        166666666666122222222222222222222221888888888881
        166666666666612222222222222222222218888888888881
        166666666666661222222222222222222188888888888881
        166666666666666122222222222222221888888888888881
        166666666666666612222222222222218888888888888881
        166666666666666661222222222222188888888888888881
        166666666666666666122222222221888888888888888881
        166666666666666666612222222218888888888888888881
        166666666666666666661222222188888888888888888881
        166666666666666666666122221888888888888888888881
        166666666666666666666612218888888888888888888881
        166666666666666666666661188888888888888888888881
        166666666666666666666661188888888888888888888881
        166666666666666666666615518888888888888888888881
        166666666666666666666155551888888888888888888881
        166666666666666666661555555188888888888888888881
        166666666666666666615555555518888888888888888881
        166666666666666666155555555551888888888888888881
        166666666666666661555555555555188888888888888881
        166666666666666615555555555555518888888888888881
        166666666666666155555555555555551888888888888881
        166666666666661555555555555555555188888888888881
        166666666666615555555555555555555518888888888881
        166666666666155555555555555555555551888888888881
        166666666661555555555555555555555555188888888881
        166666666615555555555555555555555555518888888881
        166666666155555555555555555555555555551888888881
        166666661555555555555555555555555555555188888881
        166666615555555555555555555555555555555518888881
        166666155555555555555555555555555555555551888881
        166661555555555555555555555555555555555555188881
        166615555555555555555555555555555555555555518881
        166155555555555555555555555555555555555555551881
        161555555555555555555555555555555555555555555181
        115555555555555555555555555555555555555555555511
        111111111111111111111111111111111111111111111111
        `,
    img`
        111111111111111111111111111111111111111111111111
        112222222222222222222222222222222222222222222211
        171222222222222222222222222222222222222222222181
        177122222222222222222222222222222222222222221881
        177712222222222222222222222222222222222222218881
        177771222222222222222222222222222222222222188881
        177777122222222222222222222222222222222221888881
        177777712222222222222222222222222222222218888881
        177777771222222222222222222222222222222188888881
        177777777122222222222222222222222222221888888881
        177777777712222222222222222222222222218888888881
        177777777771222222222222222222222222188888888881
        177777777777122222222222222222222221888888888881
        177777777777712222222222222222222218888888888881
        177777777777771222222222222222222188888888888881
        177777777777777122222222222222221888888888888881
        177777777777777712222222222222218888888888888881
        177777777777777771222222222222188888888888888881
        177777777777777777122222222221888888888888888881
        177777777777777777712222222218888888888888888881
        177777777777777777771222222188888888888888888881
        177777777777777777777122221888888888888888888881
        177777777777777777777712218888888888888888888881
        177777777777777777777771188888888888888888888881
        177777777777777777777771188888888888888888888881
        177777777777777777777714418888888888888888888881
        177777777777777777777144441888888888888888888881
        177777777777777777771444444188888888888888888881
        177777777777777777714444444418888888888888888881
        177777777777777777144444444441888888888888888881
        177777777777777771444444444444188888888888888881
        177777777777777714444444444444418888888888888881
        177777777777777144444444444444441888888888888881
        177777777777771444444444444444444188888888888881
        177777777777714444444444444444444418888888888881
        177777777777144444444444444444444441888888888881
        177777777771444444444444444444444444188888888881
        177777777714444444444444444444444444418888888881
        177777777144444444444444444444444444441888888881
        177777771444444444444444444444444444444188888881
        177777714444444444444444444444444444444418888881
        177777144444444444444444444444444444444441888881
        177771444444444444444444444444444444444444188881
        177714444444444444444444444444444444444444418881
        177144444444444444444444444444444444444444441881
        171444444444444444444444444444444444444444444181
        114444444444444444444444444444444444444444444411
        111111111111111111111111111111111111111111111111
        `,
    img`
        111111111111111111111111111111111111111111111111
        112222222222222222222222222222222222222222222211
        161222222222222222222222222222222222222222222181
        166122222222222222222222222222222222222222221881
        166612222222222222222222222222222222222222218881
        166661222222222222222222222222222222222222188881
        166666122222222222222222222222222222222221888881
        166666612222222222222222222222222222222218888881
        166666661222222222222222222222222222222188888881
        166666666122222222222222222222222222221888888881
        166666666612222222222222222222222222218888888881
        166666666661222222222222222222222222188888888881
        166666666666122222222222222222222221888888888881
        166666666666612222222222222222222218888888888881
        166666666666661222222222222222222188888888888881
        166666666666666122222222222222221888888888888881
        166666666666666612222222222222218888888888888881
        166666666666666661222222222222188888888888888881
        166666666666666666122222222221888888888888888881
        166666666666666666612222222218888888888888888881
        166666666666666666661222222188888888888888888881
        166666666666666666666122221888888888888888888881
        166666666666666666666612218888888888888888888881
        166666666666666666666661188888888888888888888881
        166666666666666666666661188888888888888888888881
        166666666666666666666614418888888888888888888881
        166666666666666666666144441888888888888888888881
        166666666666666666661444444188888888888888888881
        166666666666666666614444444418888888888888888881
        166666666666666666144444444441888888888888888881
        166666666666666661444444444444188888888888888881
        166666666666666614444444444444418888888888888881
        166666666666666144444444444444441888888888888881
        166666666666661444444444444444444188888888888881
        166666666666614444444444444444444418888888888881
        166666666666144444444444444444444441888888888881
        166666666661444444444444444444444444188888888881
        166666666614444444444444444444444444418888888881
        166666666144444444444444444444444444441888888881
        166666661444444444444444444444444444444188888881
        166666614444444444444444444444444444444418888881
        166666144444444444444444444444444444444441888881
        166661444444444444444444444444444444444444188881
        166614444444444444444444444444444444444444418881
        166144444444444444444444444444444444444444441881
        161444444444444444444444444444444444444444444181
        114444444444444444444444444444444444444444444411
        111111111111111111111111111111111111111111111111
        `
    ]
    music.setVolume(190)
    closebox = 45
    openbox = 120
}
function checkSimon (key: number) {
    if (simonSequence[state_step] == key) {
        state_step += 1
    } else {
        game.gameOver(false)
    }
    if (state_step == SIMON_INTERATIONS) {
        music.play(music.melodyPlayable(music.magicWand), music.PlaybackMode.InBackground)
        light.showAnimation(light.sparkleAnimation, 1000)
        state = "challenge2"
    }
}
function challenge2 () {
    name = game.askForNumber("", 4)
    if (name == PASSWORD) {
        state = "challenge3"
    } else {
        state = "challenge2"
        music.play(music.melodyPlayable(music.zapped), music.PlaybackMode.UntilDone)
    }
}
let name = 0
let openbox = 0
let PASSWORD = 0
let NOTES: number[] = []
let SPRITE_ARRAY: Image[] = []
let gameboard: Sprite = null
let SIMON_TEMPO = 0
let simonSequence: number[] = []
let SIMON_INTERATIONS = 0
let SIMON_START_DELAY = 0
let state_step = 0
let state = ""
let clue = ""
let closebox = 0
Init()
pins.D5.servoWrite(closebox)
light.clear()
pause(1000)
pins.D5.digitalWrite(false)
game.splash(clue)
state = "init"
state_step = 0
challenge1()
game.onUpdate(function () {
    if (state == "challenge2") {
        state = "challenge2a"
        challenge2()
    }
    if (state == "challenge3") {
        state = "challenge3a"
        challenge3()
    }
    if (state == "challenge3b") {
        if (state_step >= 2) {
            state = "challenge3c"
            pins.D5.servoWrite(openbox)
            music.play(music.melodyPlayable(music.jumpUp), music.PlaybackMode.UntilDone)
            light.showAnimation(light.rainbowAnimation, 1000)
            game.setGameOverMessage(true, "CONGRATULATIONS!")
            game.gameOver(true)
        }
    }
})
